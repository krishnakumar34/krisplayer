name: Build TiviMate Pro Clean

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-java@v3
      with: { java-version: '17', distribution: 'temurin' }

    - name: Build APK
      run: |
        # ---------------------------------------------------------
        # STEP 1: PREPARE FILESYSTEM
        # ---------------------------------------------------------
        # Create standard Android directory structure
        mkdir -p app/src/main/java/com/iptv/player
        mkdir -p app/src/main/res/{layout,values,drawable,xml}
        
        # Move YOUR Kotlin files to the correct package folder
        # This uses the code YOU committed, it does not overwrite it.
        mv *.kt app/src/main/java/com/iptv/player/ || true

        # ---------------------------------------------------------
        # STEP 2: GENERATE CONFIGURATION (HTTP FIXES)
        # ---------------------------------------------------------
        
        # 1. Network Security Config (ALLOW ALL HTTP & HTTPS)
        cat <<EOF > app/src/main/res/xml/network_security_config.xml
        <?xml version="1.0" encoding="utf-8"?>
        <network-security-config>
            <base-config cleartextTrafficPermitted="true">
                <trust-anchors>
                    <certificates src="system" />
                    <certificates src="user" />
                </trust-anchors>
            </base-config>
        </network-security-config>
        EOF

        # 2. Android Manifest (LINK TO NETWORK CONFIG)
        cat <<EOF > app/src/main/AndroidManifest.xml
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android">
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            
            <uses-feature android:name="android.software.leanback" android:required="false" />
            <uses-feature android:name="android.hardware.touchscreen" android:required="false" />
            
            <application
                android:allowBackup="true"
                android:label="TiviClone Pro"
                android:networkSecurityConfig="@xml/network_security_config"
                android:requestLegacyExternalStorage="true"
                android:usesCleartextTraffic="true"
                android:theme="@style/Theme.AppCompat.NoActionBar">
                
                <activity android:name=".MainActivity" android:exported="true"
                    android:screenOrientation="sensorLandscape"
                    android:configChanges="keyboard|keyboardHidden|navigation|orientation|screenSize">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                        <category android:name="android.intent.category.LEANBACK_LAUNCHER" />
                    </intent-filter>
                </activity>
            </application>
        </manifest>
        EOF

        # ---------------------------------------------------------
        # STEP 3: GENERATE BUILD FILES
        # ---------------------------------------------------------
        
        # gradle.properties
        cat <<EOF > gradle.properties
        android.useAndroidX=true
        android.enableJetifier=true
        org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
        EOF

        # settings.gradle
        echo "include ':app'" > settings.gradle

        # root build.gradle
        cat <<EOF > build.gradle
        buildscript {
            repositories { google(); mavenCentral() }
            dependencies { classpath 'com.android.tools.build:gradle:8.2.0'; classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.0' }
        }
        allprojects { repositories { google(); mavenCentral() } }
        task clean(type: Delete) { delete rootProject.buildDir }
        EOF

        # app/build.gradle (Dependencies)
        cat <<EOF > app/build.gradle
        plugins { id 'com.android.application'; id 'org.jetbrains.kotlin.android' }
        android {
            namespace 'com.iptv.player'
            compileSdk 34
            defaultConfig { applicationId 'com.iptv.player'; minSdk 21; targetSdk 34; versionCode 1; versionName '1.0' }
            buildFeatures { viewBinding true }
            compileOptions { sourceCompatibility JavaVersion.VERSION_1_8; targetCompatibility JavaVersion.VERSION_1_8 }
            kotlinOptions { jvmTarget = '1.8' }
        }
        dependencies {
            implementation 'androidx.core:core-ktx:1.12.0'
            implementation 'androidx.appcompat:appcompat:1.6.1'
            implementation 'com.google.android.material:material:1.11.0'
            implementation 'androidx.recyclerview:recyclerview:1.3.2'
            implementation 'androidx.media3:media3-exoplayer:1.2.0'
            implementation 'androidx.media3:media3-ui:1.2.0'
            implementation 'androidx.media3:media3-exoplayer-hls:1.2.0'
            implementation 'com.squareup.okhttp3:okhttp:4.12.0'
            implementation 'com.google.code.gson:gson:2.10.1'
            implementation 'androidx.drawerlayout:drawerlayout:1.2.0'
            implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3'
        }
        EOF

        # ---------------------------------------------------------
        # STEP 4: GENERATE RESOURCES (UI)
        # ---------------------------------------------------------

        # Colors
        cat <<EOF > app/src/main/res/values/colors.xml
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <color name="bg_video">#000000</color>
            <color name="bg_overlay">#E6121212</color>
            <color name="bg_panel">#1F1F1F</color>
            <color name="highlight">#29B6F6</color>
            <color name="text_primary">#FFFFFF</color>
            <color name="text_secondary">#B0BEC5</color>
            <color name="bg_focus">#37474F</color>
        </resources>
        EOF

        # Drawable Selector
        cat <<EOF > app/src/main/res/drawable/selector_item.xml
        <?xml version="1.0" encoding="utf-8"?>
        <selector xmlns:android="http://schemas.android.com/apk/res/android">
            <item android:state_focused="true"><shape><solid android:color="@color/bg_focus"/><stroke android:width="2dp" android:color="@color/highlight"/><corners android:radius="4dp"/></shape></item>
            <item><shape><solid android:color="@android:color/transparent"/><corners android:radius="4dp"/></shape></item>
        </selector>
        EOF

        # Main Layout
        cat <<EOF > app/src/main/res/layout/activity_main.xml
        <?xml version="1.0" encoding="utf-8"?>
        <androidx.drawerlayout.widget.DrawerLayout xmlns:android="http://schemas.android.com/apk/res/android"
            android:id="@+id/drawerLayout" android:layout_width="match_parent" android:layout_height="match_parent">
            <FrameLayout android:layout_width="match_parent" android:layout_height="match_parent" android:background="@color/bg_video">
                <androidx.media3.ui.PlayerView android:id="@+id/playerView"
                    android:layout_width="match_parent" android:layout_height="match_parent"
                    android:focusable="false" xmlns:app="http://schemas.android.com/apk/res-auto" app:use_controller="false" />
                <LinearLayout android:id="@+id/epgContainer"
                    android:layout_width="match_parent" android:layout_height="match_parent"
                    android:orientation="horizontal" android:background="@color/bg_overlay" android:visibility="gone" android:weightSum="10">
                    <androidx.recyclerview.widget.RecyclerView android:id="@+id/rvGroups" android:layout_width="0dp" android:layout_height="match_parent" android:layout_weight="2" android:background="@color/bg_panel" android:paddingTop="8dp" android:descendantFocusability="afterDescendants"/>
                    <androidx.recyclerview.widget.RecyclerView android:id="@+id/rvChannels" android:layout_width="0dp" android:layout_height="match_parent" android:layout_weight="8" android:paddingStart="4dp" android:paddingTop="8dp" android:descendantFocusability="afterDescendants"/>
                </LinearLayout>
                <LinearLayout android:id="@+id/recentContainer" android:layout_width="match_parent" android:layout_height="120dp" android:layout_gravity="bottom" android:background="#CC000000" android:orientation="vertical" android:visibility="gone" android:padding="8dp">
                    <TextView android:text="Recent Channels" android:layout_width="wrap_content" android:layout_height="wrap_content" android:textColor="@color/text_secondary" android:textSize="12sp" android:layout_marginBottom="4dp"/>
                    <androidx.recyclerview.widget.RecyclerView android:id="@+id/rvRecents" android:layout_width="match_parent" android:layout_height="match_parent"/>
                </LinearLayout>
                <TextView android:id="@+id/tvOverlayNum" android:layout_width="wrap_content" android:layout_height="wrap_content" android:layout_gravity="top|end" android:layout_margin="30dp" android:textSize="48sp" android:textColor="@color/text_primary" android:textStyle="bold" android:visibility="gone" android:background="#80000000" android:padding="10dp"/>
                <LinearLayout android:id="@+id/searchContainer" android:layout_width="match_parent" android:layout_height="match_parent" android:orientation="vertical" android:background="#F2121212" android:visibility="gone" android:padding="20dp">
                    <TextView android:text="Search Channels" android:layout_width="wrap_content" android:layout_height="wrap_content" android:textColor="@color/highlight" android:textSize="22sp" android:textStyle="bold" android:layout_marginBottom="10dp"/>
                    <LinearLayout android:layout_width="match_parent" android:layout_height="wrap_content" android:orientation="horizontal">
                        <EditText android:id="@+id/etSearch" android:layout_width="0dp" android:layout_height="50dp" android:layout_weight="1" android:background="@drawable/selector_item" android:padding="12dp" android:hint="Type channel name..." android:textColor="#FFF" android:textColorHint="#80FFFFFF" android:imeOptions="actionSearch" android:inputType="text"/>
                        <Button android:id="@+id/btnCloseSearch" android:layout_width="wrap_content" android:layout_height="wrap_content" android:text="Close" android:layout_marginStart="10dp"/>
                    </LinearLayout>
                    <TextView android:id="@+id/tvSearchResultsCount" android:layout_width="match_parent" android:layout_height="wrap_content" android:text="0 Results" android:textColor="@color/text_secondary" android:padding="8dp"/>
                    <androidx.recyclerview.widget.RecyclerView android:id="@+id/rvSearchResults" android:layout_width="match_parent" android:layout_height="match_parent" android:layout_marginTop="10dp"/>
                </LinearLayout>
            </FrameLayout>
            <LinearLayout android:id="@+id/settingsDrawer" android:layout_width="300dp" android:layout_height="match_parent" android:layout_gravity="end" android:background="@color/bg_panel" android:orientation="vertical" android:padding="20dp" android:clickable="true" android:focusable="true"/>
        </androidx.drawerlayout.widget.DrawerLayout>
        EOF

        # Channel Item Layout
        cat <<EOF > app/src/main/res/layout/item_channel.xml
        <?xml version="1.0" encoding="utf-8"?>
        <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android" android:layout_width="match_parent" android:layout_height="60dp" android:orientation="horizontal" android:paddingBottom="2dp" android:baselineAligned="false">
            <LinearLayout android:id="@+id/btnChannelHeader" android:layout_width="220dp" android:layout_height="match_parent" android:background="@drawable/selector_item" android:gravity="center_vertical" android:padding="8dp" android:focusable="true" android:clickable="true">
                <ImageView android:id="@+id/imgFav" android:layout_width="16dp" android:layout_height="16dp" android:visibility="gone" android:src="@android:drawable/star_on" android:tint="@color/highlight"/>
                <TextView android:id="@+id/tvNum" android:layout_width="30dp" android:layout_height="wrap_content" android:textColor="@color/highlight" android:textStyle="bold"/>
                <TextView android:id="@+id/tvName" android:layout_width="match_parent" android:layout_height="wrap_content" android:textColor="@color/text_primary" android:maxLines="1" android:ellipsize="end" android:textSize="14sp"/>
            </LinearLayout>
            <androidx.recyclerview.widget.RecyclerView android:id="@+id/rvPrograms" android:layout_width="match_parent" android:layout_height="match_parent" android:paddingStart="4dp" android:focusable="false"/>
        </LinearLayout>
        EOF

        # Program Item Layout
        cat <<EOF > app/src/main/res/layout/item_program.xml
        <?xml version="1.0" encoding="utf-8"?>
        <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android" android:layout_width="200dp" android:layout_height="match_parent" android:orientation="vertical" android:background="@drawable/selector_item" android:padding="6dp" android:layout_marginEnd="2dp" android:focusable="true" android:clickable="true">
            <TextView android:id="@+id/tvTitle" android:layout_width="match_parent" android:layout_height="wrap_content" android:textColor="@color/text_primary" android:textSize="13sp" android:maxLines="1" android:ellipsize="end"/>
            <TextView android:id="@+id/tvTime" android:layout_width="match_parent" android:layout_height="wrap_content" android:textColor="@color/text_secondary" android:textSize="11sp"/>
        </LinearLayout>
        EOF

        # ---------------------------------------------------------
        # STEP 5: RUN BUILD
        # ---------------------------------------------------------
        gradle wrapper --gradle-version 8.2
        chmod +x gradlew
        ./gradlew assembleDebug

    - uses: actions/upload-artifact@v4
      with: { name: TiviClone-Pro-APK, path: app/build/outputs/apk/debug/app-debug.apk }
      
